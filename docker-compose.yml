services:
  # 1. The Web Dashboard
  web:
    build: .
    container_name: lumina_web
    restart: always
    ports:
      - "3000:3000"
    environment:
      - MONGODB_URI=mongodb://mongo:27017/lumina
      - NEXTAUTH_URL=http://localhost:3000
      # Pass your other secrets here or use an env_file
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
    depends_on:
      - mongo
    env_file:
      - .env.local

  # 2. The Background Watcher
  watcher:
    build: .
    container_name: lumina_watcher
    restart: always
    # Override the default command to run the watcher script instead
    command: [ "npm", "run", "watch" ]
    environment:
      - MONGODB_URI=mongodb://mongo:27017/lumina
      # Needs same secrets as web
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
    depends_on:
      - mongo
    env_file:
      - .env.local

  # 3. MongoDB Database
  mongo:
    image: mongo:latest
    container_name: lumina_db
    restart: always
    ports:
      - "27017:27017" # Expose if you want to connect via Compass on host
    volumes:
      - mongo_data:/data/db

volumes:
  mongo_data:
